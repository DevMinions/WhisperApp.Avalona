name: ğŸš€ Build and Release

on:
  # å½“æ¨é€ tag æ—¶è§¦å‘ï¼ˆä¾‹å¦‚ï¼šv1.0.0ï¼‰
  push:
    tags:
      - 'v*'
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å·ï¼ˆä¾‹å¦‚ï¼š1.0.0ï¼‰'
        required: true
        default: '1.0.0'
  
  # PR æ—¶ä¹Ÿæ„å»ºï¼ˆä½†ä¸å‘å¸ƒï¼‰
  pull_request:
    branches: [ main, master ]

# é‡è¦ï¼šæ·»åŠ æƒé™ä»¥åˆ›å»º Release
permissions:
  contents: write
  packages: write

env:
  DOTNET_VERSION: '9.0.x'
  PROJECT_NAME: 'WhisperApp.Avalonia'

jobs:
  # ====================================
  # Windows æ„å»º
  # ====================================
  build-windows:
    name: ğŸªŸ Build Windows
    runs-on: windows-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ”§ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: ğŸ“¦ Restore dependencies
      run: dotnet restore
    
    - name: ğŸ—ï¸ Build Windows (x64)
      run: dotnet publish -c Release -r win-x64 --self-contained -p:PublishSingleFile=false
    
    - name: ğŸ“ Package Windows
      shell: pwsh
      run: |
        $publishDir = "WhisperApp-Windows-x64"
        New-Item -ItemType Directory -Force -Path $publishDir
        Copy-Item -Path "bin\Release\net9.0\win-x64\publish\*" -Destination $publishDir -Recurse
        
        # åˆ›å»ºå¯åŠ¨è„šæœ¬
        @"
        @echo off
        chcp 65001 >nul
        echo æ­£åœ¨å¯åŠ¨ WhisperApp...
        start WhisperApp.Avalonia.exe
        "@ | Out-File -FilePath "$publishDir\è¿è¡Œåº”ç”¨.bat" -Encoding utf8
        
        # åˆ›å»º ZIP
        Compress-Archive -Path $publishDir -DestinationPath "WhisperApp-Windows-x64.zip"
    
    - name: ğŸ“¤ Upload Windows artifact
      uses: actions/upload-artifact@v4
      with:
        name: windows-x64
        path: WhisperApp-Windows-x64.zip
        retention-days: 5

  # ====================================
  # macOS æ„å»º
  # ====================================
  build-macos:
    name: ğŸ Build macOS
    runs-on: macos-latest
    strategy:
      matrix:
        arch: 
          - { rid: 'osx-arm64', name: 'AppleSilicon' }
          - { rid: 'osx-x64', name: 'Intel' }
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ”§ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: ğŸ“¦ Restore dependencies
      run: dotnet restore
    
    - name: ğŸ—ï¸ Build macOS (${{ matrix.arch.name }})
      run: dotnet publish -c Release -r ${{ matrix.arch.rid }} --self-contained -p:PublishSingleFile=false
    
    - name: ğŸ“± Create .app bundle
      run: |
        APP_NAME="WhisperApp-${{ matrix.arch.name }}.app"
        
        # åˆ›å»º .app ç›®å½•ç»“æ„
        mkdir -p "$APP_NAME/Contents/MacOS"
        mkdir -p "$APP_NAME/Contents/Resources"
        
        # å¤åˆ¶å‘å¸ƒæ–‡ä»¶
        cp -r "bin/Release/net9.0/${{ matrix.arch.rid }}/publish/"* "$APP_NAME/Contents/MacOS/"
        
        # åˆ›å»º Info.plist
        cat > "$APP_NAME/Contents/Info.plist" << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>CFBundleName</key>
            <string>WhisperApp</string>
            <key>CFBundleDisplayName</key>
            <string>éŸ³é¢‘è½¬å½•</string>
            <key>CFBundleIdentifier</key>
            <string>com.whisperapp.avalonia</string>
            <key>CFBundleVersion</key>
            <string>1.0.0</string>
            <key>CFBundleShortVersionString</key>
            <string>1.0</string>
            <key>CFBundlePackageType</key>
            <string>APPL</string>
            <key>CFBundleExecutable</key>
            <string>WhisperApp.Avalonia</string>
            <key>LSMinimumSystemVersion</key>
            <string>10.15</string>
            <key>NSHighResolutionCapable</key>
            <true/>
        </dict>
        </plist>
        EOF
        
        # è®¾ç½®æƒé™
        chmod +x "$APP_NAME/Contents/MacOS/WhisperApp.Avalonia"
        
        # ç§»é™¤éš”ç¦»å±æ€§
        xattr -cr "$APP_NAME" || true
        
        # åˆ›å»º ZIP
        zip -r "WhisperApp-macOS-${{ matrix.arch.name }}.zip" "$APP_NAME"
    
    - name: ğŸ“¤ Upload macOS artifact
      uses: actions/upload-artifact@v4
      with:
        name: macos-${{ matrix.arch.name }}
        path: WhisperApp-macOS-${{ matrix.arch.name }}.zip
        retention-days: 5

  # ====================================
  # Linux æ„å»º
  # ====================================
  build-linux:
    name: ğŸ§ Build Linux
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ”§ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: ğŸ“¦ Restore dependencies
      run: dotnet restore
    
    - name: ğŸ—ï¸ Build Linux (x64)
      run: dotnet publish -c Release -r linux-x64 --self-contained -p:PublishSingleFile=false
    
    - name: ğŸ“ Package Linux
      run: |
        PUBLISH_DIR="WhisperApp-Linux-x64"
        mkdir -p "$PUBLISH_DIR"
        
        # å¤åˆ¶æ–‡ä»¶
        cp -r bin/Release/net9.0/linux-x64/publish/* "$PUBLISH_DIR/"
        
        # åˆ›å»ºå¯åŠ¨è„šæœ¬
        cat > "$PUBLISH_DIR/run.sh" << 'EOF'
        #!/bin/bash
        cd "$(dirname "$0")"
        ./WhisperApp.Avalonia
        EOF
        
        chmod +x "$PUBLISH_DIR/run.sh"
        chmod +x "$PUBLISH_DIR/WhisperApp.Avalonia"
        
        # åˆ›å»º .desktop æ–‡ä»¶
        cat > "$PUBLISH_DIR/whisperapp.desktop" << 'EOF'
        [Desktop Entry]
        Version=1.0
        Type=Application
        Name=WhisperApp
        Comment=éŸ³é¢‘è½¬å½•åº”ç”¨
        Exec=./run.sh
        Icon=audio-x-generic
        Terminal=false
        Categories=AudioVideo;Audio;
        EOF
        
        # åˆ›å»º tar.gz
        tar -czf WhisperApp-Linux-x64.tar.gz "$PUBLISH_DIR"
    
    - name: ğŸ“¤ Upload Linux artifact
      uses: actions/upload-artifact@v4
      with:
        name: linux-x64
        path: WhisperApp-Linux-x64.tar.gz
        retention-days: 5

  # ====================================
  # åˆ›å»º Release
  # ====================================
  create-release:
    name: ğŸ“¦ Create Release
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: ğŸ“¥ Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
    
    - name: ğŸ“‹ List artifacts
      run: ls -R artifacts/
    
    - name: ğŸ·ï¸ Get version
      id: version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
        else
          echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
        fi
    
    - name: ğŸ‰ Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.version.outputs.version }}
        name: WhisperApp v${{ steps.version.outputs.version }}
        body: |
          ## ğŸ‰ WhisperApp Avalonia v${{ steps.version.outputs.version }}
          
          ### ğŸ“¥ ä¸‹è½½è¯´æ˜
          
          #### ğŸªŸ Windows
          - ä¸‹è½½ `WhisperApp-Windows-x64.zip`
          - è§£å‹ååŒå‡» `WhisperApp.Avalonia.exe` è¿è¡Œ
          
          #### ğŸ macOS
          - **Apple Silicon (M1/M2/M3)**: ä¸‹è½½ `WhisperApp-macOS-AppleSilicon.zip`
          - **Intel**: ä¸‹è½½ `WhisperApp-macOS-Intel.zip`
          - è§£å‹ååŒå‡» `.app` æ–‡ä»¶è¿è¡Œ
          - å¦‚æœæç¤ºå®‰å…¨è­¦å‘Šï¼Œå³é”®ç‚¹å‡»é€‰æ‹©"æ‰“å¼€"æˆ–è¿è¡Œ: `xattr -cr WhisperApp-*.app`
          
          #### ğŸ§ Linux
          - ä¸‹è½½ `WhisperApp-Linux-x64.tar.gz`
          - è§£å‹: `tar -xzf WhisperApp-Linux-x64.tar.gz`
          - è¿è¡Œ: `./WhisperApp-Linux-x64/run.sh`
          
          ### âœ¨ æ›´æ–°å†…å®¹
          - Avalonia è·¨å¹³å° UI æ¡†æ¶
          - æ”¯æŒ Windowsã€macOSã€Linux
          - éŸ³é¢‘è½¬å½•åŠŸèƒ½
          
          ### ğŸ“ æ³¨æ„äº‹é¡¹
          - macOS ç‰ˆæœ¬æœªç­¾åï¼Œé¦–æ¬¡è¿è¡Œéœ€è¦å…è®¸å®‰å…¨æƒé™
          - Linux ç‰ˆæœ¬éœ€è¦å®‰è£…ç›¸å…³ä¾èµ–ï¼ˆX11ã€libfontconfig ç­‰ï¼‰
          
        files: |
          artifacts/windows-x64/WhisperApp-Windows-x64.zip
          artifacts/macos-AppleSilicon/WhisperApp-macOS-AppleSilicon.zip
          artifacts/macos-Intel/WhisperApp-macOS-Intel.zip
          artifacts/linux-x64/WhisperApp-Linux-x64.tar.gz
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

